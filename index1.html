<script>
  const dateEl = document.getElementById("date");
  const morningMoodEl = document.getElementById("morning-mood");
  const eveningMoodEl = document.getElementById("evening-mood");
  const journalTextEl = document.getElementById("journal-text");
  const encouragementEl = document.getElementById("encouragement");
  const historyListEl = document.getElementById("history-list");

  const today = new Date().toISOString().split("T")[0];
  dateEl.textContent = `Date: ${today}`;
  loadEntry(today);
  updateHistory();

  function selectEmoji(container, selectedEmoji) {
    const emojis = container.querySelectorAll("span");
    emojis.forEach(span => {
      span.classList.toggle("selected", span.textContent === selectedEmoji);
    });
  }

  morningMoodEl.addEventListener("click", e => {
    if (e.target.tagName === "SPAN") selectEmoji(morningMoodEl, e.target.textContent);
  });
  eveningMoodEl.addEventListener("click", e => {
    if (e.target.tagName === "SPAN") selectEmoji(eveningMoodEl, e.target.textContent);
  });

  document.getElementById("save-button").addEventListener("click", () => {
    const morningMood = morningMoodEl.querySelector(".selected")?.textContent || "";
    const eveningMood = eveningMoodEl.querySelector(".selected")?.textContent || "";
    const text = journalTextEl.value.trim();
    const entry = { morningMood, eveningMood, text };
    localStorage.setItem(today, JSON.stringify(entry));

    if (["ðŸ˜ž", "ðŸ˜¡", "ðŸ˜­"].includes(morningMood) || ["ðŸ˜ž", "ðŸ˜¡", "ðŸ˜­"].includes(eveningMood)) {
      encouragementEl.textContent = "It's okay to feel this way. Try a deep breath, a short walk, or reaching out to someone you trust â¤ï¸";
    } else encouragementEl.textContent = "Great job checking in today! ðŸŒŸ";

    updateHistory();
  });

  function loadEntry(date) {
    const saved = JSON.parse(localStorage.getItem(date));
    if (saved) {
      selectEmoji(morningMoodEl, saved.morningMood);
      selectEmoji(eveningMoodEl, saved.eveningMood);
      journalTextEl.value = saved.text;
    } else {
      selectEmoji(morningMoodEl, "");
      selectEmoji(eveningMoodEl, "");
      journalTextEl.value = "";
    }
    encouragementEl.textContent = "";
  }

  function updateHistory() {
    historyListEl.innerHTML = "";
    const keys = Object.keys(localStorage).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k)).sort().reverse();
    keys.forEach(date => {
      const link = document.createElement("div");
      link.className = "entry-link";
      link.textContent = date;
      link.onclick = () => {
        loadEntry(date);
        dateEl.textContent = `Date: ${date}`;
      };
      historyListEl.appendChild(link);
    });
  }

  // ===== Notification setup =====
  if ("Notification" in window) {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        console.log("Notifications allowed!");

        // Check every minute whether it's time for the daily reminder
        setInterval(() => {
          const now = new Date();
          const hours = now.getHours();
          const minutes = now.getMinutes();

          // Change 9,0 to any time you like (e.g., 21,0 for 9pm)
          if (hours === 9 && minutes === 0) {
            new Notification("ðŸŒž Time to check your journal!", {
              body: "How are you feeling today? Write it down to track your moods.",
              icon: "https://upload.wikimedia.org/wikipedia/commons/8/89/HD_transparent_picture.png" // transparent icon
            });
          }
        }, 60000); // every minute
      } else {
        console.log("Notifications denied or not supported.");
      }
    });
  }
</script>
